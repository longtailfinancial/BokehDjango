
########################################
# Secure the Server
########################################

# If you decide to host this via Linode and don't already have a Linode account,
# please consider using the following referral link to register.  This gives me a modest amount of Linode "credit"
# that will allow me to keep the demo site up and running at http://45.33.6.39

# https://www.linode.com/?r=8b4f4ca1bfe379f086fbacc8dde3a5c138296e48
# referral code: 8b4f4ca1bfe379f086fbacc8dde3a5c138296e48

# Rebuilding for Ubuntu 20.04 LTS - July 2nd 2020 Shawn Anderson Longtail Financial Corp.
# Starting at approximately 8:00PM. First time following this recipe.
# Boot
# Log in as root

# Update sshd configuration
vim /etc/ssh/sshd_config
    PermitRootLogin no
    PasswordAuthentication no
    UsePAM no

# update the machine
apt-get update
apt-get install gcc -y
apt install python3.8-dev -y
apt-get upgrade -y
apt-get install fail2ban -y
apt-get install xclip -y

apt-get install git-core -y
apt-get install virtualenv -y
apt-get install gunicorn -y
apt-get install nginx -y

########################################
# Setting up the user
########################################/
### Variables
# set user "Shawn Anderson"
# set password
# set group "ltfdev"

# create the group
/usr/sbin/groupadd ltfdev

# back up the sudoers file
cp /etc/sudoers /etc/sudoers-backup

# modify the sudo list so the group has sudo privileges
(cat /etc/sudoers-backup ; echo "%ltfdev ALL=(ALL) ALL") > /etc/sudoers
# ensure the appropriate permissions are on the sudoers file
chmod 0440 /etc/sudoers

# create the new user. be sure to use your own name here
/usr/sbin/useradd -c "Shawn Anderson" -m -g ltfdev shawn

# set up a password for the new user. you'll need the password to run sudo commands
/usr/bin/passwd shawn

# add the deployer user to the group
/usr/sbin/usermod -a -G ltfdev shawn

# create a directory for the deployer's public key and authorized_keys file
mkdir /home/shawn/.ssh

### ***************
### create a public/private key pair on your local computer
# List your keys
# ls -l ~/.ssh/id_*.pub
# Generate a key
# ssh-keygen -t rsa -b 4096 -C "your_email@pm.me"
# ~/.ssh/NAME_YOUR_KEY
# PASSPHRASE

# ** Stopping here right now (8:49pm)
# ** Continuing (8:54pm)
# create the authorized_keys file (the public key) on your webserver
vi /home/shawn/.ssh/authorized_keys

# change the owner and group of the .ssh directory to shawn
# and ltfdev, respectively

chown -R shawn /home/shawn/.ssh
chgrp -R ltfdev /home/shawn/.ssh

# restart SSH Service
service ssh reload

# before logging out as root,  check to make sure you can log in as deployer
# if it works log out of the root SSH session

# from now on, log in as shawn

# create a deploy key
# save the private key in our current directory ./deploy_key
# Press enter twice when prompted for a passphrase. We will not use a passphrase on the deploy key.
mkdir ~/deploy_key
cd ~/deploy_key
ssh-keygen -t rsa -b 2048
./deploy_key

# add the deploy_key.pub to github


# ** 9:03PM
########################################
# Source Control
########################################

# make sure the deploy key is set up on your github repository
cd /home/shawn
# the next line must point to your personal repository, so replace jonolsu with your github ID
ssh-agent bash -c 'ssh-add /home/shawn/deploy_key/deploy_key; git clone git@github.com:longtailfinancial/panel-django.git'


########################################
# Create the Environment
########################################
# set repository panel-django

mkdir /home/shawn/envs/
# determine which version of python3 is installed and name the environment appropriately
python3 --version
virtualenv -p python3 /home/shawn/envs/panel-django
/bin/bash
source /home/shawn/envs/panel-django/bin/activate
pip install --upgrade pip
pip install -r /home/shawn/panel-django/requirements.txt


########################################
# Setting up the Web Server
# https://www.digitalocean.com/community/tutorials/how-to-set-up-django-with-postgres-nginx-and-gunicorn-on-ubuntu-16-04
########################################

# set up the firewall
sudo ufw allow 22
sudo ufw allow 80
sudo ufw enable


# create gunicorn.service file (gunicorn.service is located in the config_files directory of the repository)
sudo vi /etc/systemd/system/gunicorn.service

#  start the Gunicorn service we created and enable it so that it starts at boot:
sudo systemctl start gunicorn
sudo systemctl enable gunicorn

# Configure Nginx to Proxy Pass to Gunicorn (mysite is located in the config_files directory of the repository)
# replace the up address with your server's ip address
sudo vi /etc/nginx/sites-available/mysite

# enable the file
sudo ln -s /etc/nginx/sites-available/mysite /etc/nginx/sites-enabled

#
sudo ufw allow 'Nginx Full'

# restart Nginx
sudo systemctl restart nginx


########################################
# Configuring the Bokeh Server
########################################

# create bokehserver.service file (bokehserver.service is located in the config_files directory of the repository)
sudo vi /etc/systemd/system/bokehserver.service

#  start the bokehserver service we created and enable it so that it starts at boot:
sudo systemctl start bokehserver
sudo systemctl enable bokehserver

########################################
# Ready to Go
########################################

# reboot your system and navigate to your website
sudo shutdown -r now
# use the browser to navigate to your website http://45.33.6.39
# userid is regularuser
# password is 1234password1234
# administrator id is admin
# password is 1234password1234

########################################
# Other
########################################

# if you update your Django Application
cd /home/deployer1/BokehDjango
ssh-agent bash -c 'ssh-add /home/deployer1/deploy_key/deploy_key; git pull origin master'
sudo systemctl restart gunicorn

# if you change gunicorn service
sudo systemctl daemon-reload
sudo systemctl restart gunicorn

# if you change bokehserver service
sudo systemctl daemon-reload
sudo systemctl restart bokehserver

# if you change nginx
s


